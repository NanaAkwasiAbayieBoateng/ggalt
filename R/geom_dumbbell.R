#' Dumbbell charts
#'
#' The dumbbell geom is used to create dumbbell charts.
#'
#' Dumbbell dot plots — dot plots with two or more series of data — are an
#' alternative to the clustered bar chart or slope graph.
#'
#' @section Aesthetics:
#' \Sexpr[results=rd,stage=build]{ggplot2:::rd_aesthetics("geom", "segment")}
#' @inheritParams ggplot2::layer
#' @param na.rm If \code{FALSE} (the default), removes missing values with
#'    a warning.  If \code{TRUE} silently removes missing values.
#' @param ... other arguments passed on to \code{\link{layer}}. These are
#'   often aesthetics, used to set an aesthetic to a fixed value, like
#'   \code{color = "red"} or \code{size = 3}. They may also be parameters
#'   to the paired geom/stat.
#' @param size_x,size_xend the size of the x/xend; defaults to 0.5
#' @param colour_x,colour_xend the colour of x/xend; defaults to colour aes
#' @param shape_x,shape_xend shape to use for x/xend; defaults to 19
#' @param fill_x,fill_xend fill for x/xend if the shape is hollow; defaults to fill aes
#' @param dot_guide if \code{TRUE}, a leading dotted line will be placed before the left-most dumbbell point
#' @param dot_guide_size,dot_guide_colour singe-value ahesthetics for \code{dot_guide}
#' @param jitter_on_equal_values numeric value [0..1], default is 0. If non-zero and if both
#'        values are equal, jitter the points vertically by the amount specified so
#'        they don't fully overlap.
#' @param position Position adjustment, either as a string, or the result of a
#'   call to a position adjustment function.
#' @inheritParams ggplot2::layer
#' @export
#' @examples
#' library(ggplot2)
#'
#' data.frame(
#'   trt = factor(LETTERS[1:5], levels = LETTERS[5:1]),
#'   l = c(20, 40, 30, 30, 50),
#'   r = c(70, 50, 10, 60, 80)
#' ) -> df
#'
#' ggplot(df, aes(y=trt, x=l, xend=r)) +
#'   geom_dumbbell(size=3, color="#e3e2e1",
#'                 colour_x = "#5b8124", colour_xend = "#bad744",
#'                 dot_guide=TRUE, dot_guide_size=0.25) +
#'   labs(x=NULL, y=NULL, title="ggplot2 geom_dumbbell with dot guide") +
#'   theme_minimal() +
#'   theme(panel.grid.major.x=element_line(size=0.05))
#'
#' ggplot(df, aes(y=trt, x=l, xend=r)) +
#'   geom_dumbbell(size=3, color="#e3e2e1",
#'                 colour_x = "#5b8124", colour_xend = "#bad744", shape_x = 15,
#'                 dot_guide=TRUE, dot_guide_size=0.25) +
#'   labs(x=NULL, y=NULL, title="ggplot2 geom_dumbbell with dot guide") +
#'   theme_minimal() +
#'   theme(panel.grid.major.x=element_line(size=0.05))
#'
#' ## with vertical dodging
#' df2 <- data.frame(trt = c(LETTERS[1:5], "D"),
#'                  l = c(20, 40, 10, 30, 50, 40),
#'                  r = c(70, 50, 30, 60, 80, 70))
#'
#' ggplot(df2, aes(y=trt, x=l, xend=r)) +
#'   geom_dumbbell(size=3, color="#e3e2e1",
#'                 colour_x = "#5b8124", colour_xend = "#bad744",
#'                 dot_guide=TRUE, dot_guide_size=0.25,
#'                 position=position_dodgev(height=0.4)) +
#'   labs(x=NULL, y=NULL, title="ggplot2 geom_dumbbell with dot guide") +
#'   theme_minimal() +
#'   theme(panel.grid.major.x=element_line(size=0.05))
geom_dumbbell <- function(mapping = NULL, data = NULL, ...,
                          colour_x = NULL, size_x = NULL, shape_x = NULL, fill_x = NULL,
                          colour_xend = NULL, size_xend = NULL, shape_xend = NULL, fill_xend = NULL,
                          dot_guide = FALSE, dot_guide_size = NULL,
                          dot_guide_colour = NULL, jitter_on_equal_values = 0,
                          na.rm = FALSE, show.legend = NA, inherit.aes = TRUE,
                          position = "identity") {

  layer(
    data = data,
    mapping = mapping,
    stat = "identity",
    geom = GeomDumbbell,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      na.rm = na.rm,
      colour_x = colour_x,
      size_x = size_x,
      shape_x = shape_x,
      fill_x = fill_x,
      colour_xend = colour_xend,
      size_xend = size_xend,
      shape_xend = shape_xend,
      fill_xend = fill_xend,
      dot_guide = dot_guide,
      dot_guide_size = dot_guide_size,
      dot_guide_colour = dot_guide_colour,
      jitter_on_equal_values = jitter_on_equal_values,
      ...
    )
  )
}

#' @rdname ggalt-ggproto
#' @format NULL
#' @usage NULL
#' @export
GeomDumbbell <- ggproto("GeomDumbbell", Geom,
  required_aes = c("x", "xend", "y"),
  non_missing_aes = c("size", "shape",
                      "colour_x", "size_x", "shape_x", "fill_x",
                      "colour_xend", "size_xend", "shape_xend", "fill_xend",
                      "dot_guide", "dot_guide_size", "dot_guide_colour",
                      "jitter_on_equal_values"),
  default_aes = aes(
    shape = 19, colour = "black", size = 0.5, fill = NA,
    alpha = NA, stroke = 0.5
  ),

  setup_data = function(data, params) {
    transform(data, point_y = y, yend = y, dot_yend = y)
  },

  draw_group = function(data, panel_scales, coord,
                        colour_x = NULL, size_x = NULL, shape_x = NULL, fill_x = NULL,
                        colour_xend = NULL, size_xend = NULL, shape_xend = NULL, fill_xend = NULL,
                        dot_guide = NULL, dot_guide_size = NULL,
                        dot_guide_colour = NULL, jitter_on_equal_values) {

    points.x <- data
    points.x$y <- points.x$point_y
    points.x$colour <- colour_x %||% data$colour
    points.x$fill <- fill_x %||% data$fill
    points.x$shape <- shape_x %||% 19
    points.x$xend <- NULL
    points.x$size <- size_x %||% (data$size * 1.2)

    points.xend <- data
    points.xend.y <- points.xend$yend
    points.xend$x <- points.xend$xend
    points.xend$colour <- colour_xend %||% data$colour
    points.xend$fill <- fill_xend %||% data$fill
    points.xend$xend <- NULL
    points.xend$shape <- shape_xend %||% 19
    points.xend$colour <- colour_xend %||% data$colour
    points.xend$size <- size_xend %||% (data$size * 1.25)

    dot_df <- data
    dot_df$xend <- ifelse(data$xend < data$x, data$xend, data$x)
    dot_df$yend <- dot_df$dot_yend
    dot_df$x <- -Inf
    dot_df$linetype <- "11"
    dot_df$size <- dot_guide_size %||% (data$size * 0.5)
    dot_df$colour <- dot_guide_colour %||% "#5b5b5b"

    if (is.null(dot_guide) | !dot_guide) {

      gList(
        ggplot2::GeomSegment$draw_panel(data, panel_scales, coord),
        ggplot2::GeomPoint$draw_panel(points.x, panel_scales, coord),
        ggplot2::GeomPoint$draw_panel(points.xend, panel_scales, coord)
      )

    } else {

      gList(
        ggplot2::GeomSegment$draw_panel(dot_df, panel_scales, coord),
        ggplot2::GeomSegment$draw_panel(data, panel_scales, coord),
        ggplot2::GeomPoint$draw_panel(points.x, panel_scales, coord),
        ggplot2::GeomPoint$draw_panel(points.xend, panel_scales, coord)
      )

    }

  },

  draw_key = draw_key_point

)


